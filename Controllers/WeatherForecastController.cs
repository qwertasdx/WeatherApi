using Microsoft.AspNetCore.Mvc;
using System.Text.Json;
using WeatherApi.Services;


namespace WeatherApi.Controllers
{
    [ApiController]
    [Route("[controller]")]
    public class WeatherForecastController : ControllerBase
    {
        private readonly ILogger<WeatherForecastController> _logger;
        private readonly WeatherService _cityWeatherService;

        public WeatherForecastController(ILogger<WeatherForecastController> logger, WeatherService cityWeatherService)
        {
            _logger = logger;
            _cityWeatherService = cityWeatherService;
        }

        //測試JSON資料
        [HttpGet(Name = "GetWeatherForecast")]
        public async Task<IActionResult> GetWeather()
        {
            var filePath = Path.Combine(Directory.GetCurrentDirectory(), "test.json");

            if (!System.IO.File.Exists(filePath))
            {
                return NotFound("File not found");
            }

            var jsonData = await System.IO.File.ReadAllTextAsync(filePath);

            using (JsonDocument doc = JsonDocument.Parse(jsonData))
            {
                // 提取 Locations
                var locationsElement = doc.RootElement
                    .GetProperty("records")
                    .GetProperty("Locations");

                if (locationsElement.ValueKind == JsonValueKind.Null)
                {
                    return NotFound("查無資料");
                }

                var finalResult = new List<string>();

                foreach (var locations in locationsElement.EnumerateArray())
                {
                    var locationArray = locations.GetProperty("Location");

                    foreach (var location in locationArray.EnumerateArray())
                    {
                        var locationName = location.GetProperty("LocationName").GetString();
                        var weatherElements = location.GetProperty("WeatherElement");

                        // 用於儲存當前位置的天氣數據
                        var temperatureData = new Dictionary<string, (string AvgTemp, string MaxTemp, string MinTemp)>();

                        // 此資料是撈12小時天氣預報，固只參考每天早上6點至下午6點資料
                        foreach (var weatherElement in weatherElements.EnumerateArray())
                        {
                            var elementName = weatherElement.GetProperty("ElementName").GetString();
                            var times = weatherElement.GetProperty("Time");

                            foreach (var time in times.EnumerateArray())
                            {
                                var startTime = time.GetProperty("StartTime").GetString();
                                DateTime parsedDateTime = DateTime.Parse(startTime);

                                // 只處理startTime為早上6點的資料
                                if (parsedDateTime.TimeOfDay == TimeSpan.FromHours(6))
                                {
                                    string formattedDate = $"{parsedDateTime:yyyy-MM-dd} 06:00:00"; 

                                    if (!temperatureData.ContainsKey(formattedDate))
                                    {
                                        temperatureData[formattedDate] = ("", "", "");
                                    }

                                    switch (elementName)
                                    {
                                        case "平均溫度":
                                            var temperature = time.GetProperty("ElementValue")[0].GetProperty("Temperature").GetString();
                                            temperatureData[formattedDate] = (temperature, temperatureData[formattedDate].MaxTemp, temperatureData[formattedDate].MinTemp);
                                            break;
                                        case "最高溫度":
                                            var maxTemperature = time.GetProperty("ElementValue")[0].GetProperty("MaxTemperature").GetString();
                                            temperatureData[formattedDate] = (temperatureData[formattedDate].AvgTemp, maxTemperature, temperatureData[formattedDate].MinTemp);
                                            break;
                                        case "最低溫度":
                                            var minTemperature = time.GetProperty("ElementValue")[0].GetProperty("MinTemperature").GetString();
                                            temperatureData[formattedDate] = (temperatureData[formattedDate].AvgTemp, temperatureData[formattedDate].MaxTemp, minTemperature);
                                            break;
                                    }
                                }                              
                            }                               
                        }
       
                        foreach (var entry in temperatureData)
                        {
                            var formattedResult = $"{entry.Key},{locationName},平均溫度:{entry.Value.AvgTemp}度,最高溫度:{entry.Value.MaxTemp}度,最低溫度:{entry.Value.MinTemp}度";
                            finalResult.Add(formattedResult);
                        }
                    }                 
                }
              
                return Ok(finalResult);
            }
        }

        [HttpGet("{cityName}")]
        public async Task<IActionResult> GetWeather(string cityName)
        {
            //由於此api是抓12小時天氣預報，所以由凌晨6點至下午6點
            DateTime timeFrom = DateTime.Today;
            DateTime timeTo = timeFrom.AddDays(7).AddHours(23).AddMinutes(59).AddSeconds(59);
            string formattedTimeFrom = timeFrom.ToString("yyyy-MM-ddT06:00:00");         
            string formattedTimeTo = timeTo.ToString("yyyy-MM-ddTHH:mm:ss");

            var forecastData = await _cityWeatherService.GetCityWeatherForecastAsync(cityName, formattedTimeFrom, formattedTimeTo);
            if (string.IsNullOrEmpty(forecastData))
            {
                return NotFound("查無溫度資料");
            }

            using (JsonDocument doc = JsonDocument.Parse(forecastData))
            {
                // 提取 Locations
                var locationsElement = doc.RootElement
                    .GetProperty("records")
                    .GetProperty("Locations");

                if (locationsElement.ValueKind == JsonValueKind.Null)
                {
                    return NotFound("查無資料");
                }

                var finalResult = new List<string>();

                foreach (var locations in locationsElement.EnumerateArray())
                {
                    var locationArray = locations.GetProperty("Location");

                    foreach (var location in locationArray.EnumerateArray())
                    {
                        var locationName = location.GetProperty("LocationName").GetString();
                        var weatherElements = location.GetProperty("WeatherElement");

                        // 用於儲存當前位置的天氣數據
                        var temperatureData = new Dictionary<string, (string AvgTemp, string MaxTemp, string MinTemp)>();

                        // 此資料是撈12小時天氣預報，固只參考每天早上6點至下午6點資料
                        foreach (var weatherElement in weatherElements.EnumerateArray())
                        {
                            var elementName = weatherElement.GetProperty("ElementName").GetString();
                            var times = weatherElement.GetProperty("Time");

                            foreach (var time in times.EnumerateArray())
                            {
                                var startTime = time.GetProperty("StartTime").GetString();
                                DateTime parsedDateTime = DateTime.Parse(startTime);

                                // 只處理startTime為早上6點的資料
                                if (parsedDateTime.TimeOfDay == TimeSpan.FromHours(6))
                                {
                                    string formattedDate = $"{parsedDateTime:yyyy-MM-dd} 06:00:00";

                                    if (!temperatureData.ContainsKey(formattedDate))
                                    {
                                        temperatureData[formattedDate] = ("", "", "");
                                    }

                                    switch (elementName)
                                    {
                                        case "平均溫度":
                                            var temperature = time.GetProperty("ElementValue")[0].GetProperty("Temperature").GetString();
                                            temperatureData[formattedDate] = (temperature, temperatureData[formattedDate].MaxTemp, temperatureData[formattedDate].MinTemp);
                                            break;
                                        case "最高溫度":
                                            var maxTemperature = time.GetProperty("ElementValue")[0].GetProperty("MaxTemperature").GetString();
                                            temperatureData[formattedDate] = (temperatureData[formattedDate].AvgTemp, maxTemperature, temperatureData[formattedDate].MinTemp);
                                            break;
                                        case "最低溫度":
                                            var minTemperature = time.GetProperty("ElementValue")[0].GetProperty("MinTemperature").GetString();
                                            temperatureData[formattedDate] = (temperatureData[formattedDate].AvgTemp, temperatureData[formattedDate].MaxTemp, minTemperature);
                                            break;
                                    }
                                }
                            }
                        }

                        foreach (var entry in temperatureData)
                        {
                            var formattedResult = $"{entry.Key},{locationName},平均溫度:{entry.Value.AvgTemp}度,最高溫度:{entry.Value.MaxTemp}度,最低溫度:{entry.Value.MinTemp}度";
                            finalResult.Add(formattedResult);
                        }
                    }
                }

                return Ok(finalResult);
            }    
        }
    }
}
